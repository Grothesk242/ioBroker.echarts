import{j as n}from"./jsx-runtime-B_PeHe7p.js";import{R as v,e as p}from"./echarts__loadShare__react__loadShare__-DHnYtG7m.js";import{e as m,a as g}from"./echarts__loadShare___mf_0_mui_mf_1_icons_mf_2_material__loadShare__-D8lMmZml.js";import{e as y,a as b}from"./echarts__mf_v__runtimeInit__mf_v__-fP5VN0RR.js";import"./_commonjsHelpers-Cpj98o6Y.js";const{loadShare:x}=b,{initPromise:C}=y,D=C.then(o=>x("@iobroker/adapter-react-v5",{customShareInfo:{shareConfig:{singleton:!0,strictVersion:!1,requiredVersion:"*"}}})),S=await D.then(o=>o());var c=S;function w(o){const[a,s]=p.useState(null);return p.useEffect(()=>{o.context.socket.getObjectViewSystem("chart","echarts.","echarts.é¦™").then(e=>{const r=[];e&&Object.values(e).forEach(t=>t._id&&!t._id.toString().endsWith(".")&&r.push(t._id));const i=[];r.forEach(t=>{const l=t.split(".");if(l.length>=3){l.shift(),l.shift();const d=[];for(let h=0;h<l.length-1;h++){d.push(l[h]);const u=d.join(".");i.find(f=>f.path===u)||i.push({path:u,name:l[h],level:d.length})}d.push(l[l.length-1]),i.push({path:l.join("."),name:l[l.length-1],level:d.length,id:t})}}),i.sort((t,l)=>t.path.localeCompare(l.path)),s(i)})},[]),a?n.jsxs(m.Select,{style:{width:"100%"},value:o.data[o.field.name]||"",onChange:e=>{const r={...o.data,[o.field.name]:e.target.value};o.setData(r)},renderValue:e=>(e==null?void 0:e.toString().substring(10))||"",variant:"standard",children:[n.jsx(m.MenuItem,{value:"",children:c.I18n.t("echarts_none")},"___none"),a.map(e=>n.jsx(m.MenuItem,{value:e.id||e.name,disabled:!e.id,children:n.jsxs("div",{style:{paddingLeft:e.level*20,display:"flex"},children:[n.jsx("span",{style:{paddingRight:4},children:e.id?n.jsx(g.Timeline,{}):n.jsx(c.IconClosed,{})}),e.name]})},e.name))]}):null}class _ extends window.visRxWidget{refIframe=v.createRef();ready=!1;lastPresetData="";systemConfig=null;object=null;constructor(a){super(a),this.state={...this.state,presetData:null}}static getWidgetInfo(){return{id:"tplEchartsChart",visSet:"echarts",visSetLabel:"set_label",visSetColor:"#aa314d",visWidgetLabel:"E-Charts",visName:"E-Charts",visAttrs:[{name:"common",fields:[{name:"noCard",label:"without_card",type:"checkbox",default:!1},{name:"widgetTitle",label:"name",hidden:"!!data.noCard"},{label:"noChartBackground",name:"noChartBackground",type:"checkbox",default:!0,hidden:"!data.noCard"},{label:"echart_oid",name:"echart_oid",type:"custom",hidden:"!!data.history_instance || !!data.history_oid",component:(a,s,e,r)=>n.jsx(w,{field:a,data:s,setData:e,context:r.context})},{label:"history_instance",name:"history_instance",type:"instance",hidden:"!!data.echart_oid",adapter:"_dataSources"},{label:"history_oid",name:"history_oid",type:"id",hidden:"!!data.echart_oid || !data.history_instance",filter:a=>({common:{custom:a.history_instance}})},{label:"chartType",name:"chartType",default:"auto",hidden:"!data.history_oid",type:"select",options:[{value:"auto",label:"Auto"},{value:"line",label:"Line"},{value:"bar",label:"Bar"},{value:"scatterplot",label:"Scatter plot"},{value:"steps",label:"Steps"},{value:"stepsStart",label:"Steps on start"},{value:"spline",label:"Spline"}]},{label:"aggregate",name:"aggregate",default:"minmax",hidden:'!data.history_oid || data.chartType === "auto" || !data.chartType',type:"select",noTranslation:!0,options:["minmax","average","min","max","total","raw"]},{label:"live",name:"live",default:"30",type:"select",hidden:"!data.history_oid",options:[{value:"",label:"none"},{value:"5",label:"5 seconds"},{value:"10",label:"10 seconds"},{value:"15",label:"15 seconds"},{value:"20",label:"20 seconds"},{value:"30",label:"30 seconds"},{value:"60",label:"1 minute"},{value:"120",label:"2 minutes"},{value:"300",label:"5 minutes"},{value:"600",label:"10 minutes"},{value:"900",label:"15 minutes"},{value:"1200",label:"20 minutes"},{value:"1800",label:"30 minutes"},{value:"3600",label:"1 hour"},{value:"7200",label:"2 hours"},{value:"10800",label:"3 hours"},{value:"21600",label:"6 hours"},{value:"43200",label:"12 hours"},{value:"86400",label:"1 day"}]},{label:"aggregateType",name:"aggregateType",default:"step",hidden:"!data.history_oid",type:"select",options:[{label:"counts",value:"count"},{label:"seconds",value:"step"}]},{label:"aggregateSpan",name:"aggregateSpan",default:300,type:"number",hidden:"!data.history_oid"},{label:"xticks",name:"xticks",type:"slider",min:0,max:50,hidden:"!data.history_oid"},{label:"yticks",name:"yticks",type:"slider",min:0,max:50,hidden:"!data.history_oid"},{label:"range",name:"range",default:"1440",hidden:"!data.history_oid",type:"select",options:[{value:"10",label:"10 minutes"},{value:"30",label:"30 minutes"},{value:"60",label:"1 hour"},{value:"120",label:"2 hours"},{value:"180",label:"3 hours"},{value:"360",label:"6 hours"},{value:"720",label:"12 hours"},{value:"1440",label:"1 day"},{value:"2880",label:"2 days"},{value:"4320",label:"3 days"},{value:"10080",label:"7 days"},{value:"20160",label:"14 days"},{value:"1m",label:"1 month"},{value:"2m",label:"2 months"},{value:"3m",label:"3 months"},{value:"6m",label:"6 months"},{value:"1y",label:"1 year"},{value:"2y",label:"2 years"}]},{label:"relativeEnd",name:"relativeEnd",default:"now",hidden:"!data.history_oid",type:"select",options:[{value:"now",label:"now"},{value:"1minute",label:"end of minute"},{value:"5minutes",label:"end of 5 minutes"},{value:"10minutes",label:"end of 10 minutes"},{value:"30minutes",label:"end of 30 minutes"},{value:"1hour",label:"end of hour"},{value:"2hours",label:"end of 2 hours"},{value:"3hours",label:"end of 3 hours"},{value:"4hours",label:"end of 4 hours"},{value:"6hours",label:"end of 6 hours"},{value:"8hours",label:"end of 8 hours"},{value:"12hours",label:"end of 12 hours"},{value:"today",label:"end of day"},{value:"weekEurope",label:"end of sunday"},{value:"weekUsa",label:"end of saturday"},{value:"month",label:"this month"},{value:"year",label:"this year"}]}]}],visDefaultStyle:{width:"100%",height:300,position:"relative"},visPrev:"widgets/echarts/img/prev_echarts.png"}}getWidgetInfo(){return _.getWidgetInfo()}static getDefaultLine(a,s,e,r){var l,d,h,u;const i=((l=e==null?void 0:e.common)==null?void 0:l.type)==="boolean",t={name:(((d=e==null?void 0:e.common)==null?void 0:d.name)&&c.Utils.getObjectNameFromObj(e,null,{language:r})||"").trim(),id:(e==null?void 0:e._id)||"",instance:s===a.common.defaultHistory?"":s||"",thickness:2,chartType:i?"steps":"line",aggregate:i?"onchange":"minmax",isBoolean:i,symbolSize:3,validTime:35};return(h=e==null?void 0:e.common)!=null&&h.color&&(t.color=e.common.color),(u=e==null?void 0:e.common)!=null&&u.unit&&(t.unit=e.common.unit),i&&(t.yaxe="off",t.min="0",t.yticks=1,t.fill=.3,t.symbolSize=1),t}loadChartParam(a,s){const e=this.state.rxData[a];return e??s}async propertiesUpdate(){this.state.rxData.history_oid&&this.state.rxData.history_instance?this.setState({presetData:await this.createChartFromLine()}):this.state.presetData&&this.setState({presetData:null})}async componentDidMount(){super.componentDidMount(),window.addEventListener("message",this.onReceiveMessage,!1),await this.propertiesUpdate()}componentWillUnmount(){window.removeEventListener("message",this.onReceiveMessage,!1)}async onRxDataChanged(){await this.propertiesUpdate()}async createChartFromLine(){this.systemConfig||=await this.props.context.socket.getObject("system.config"),(!this.object||this.object._id!==this.state.rxData.history_oid)&&(this.object=await this.props.context.socket.getObject(this.state.rxData.history_oid));const a=[_.getDefaultLine(this.systemConfig,this.state.rxData.history_instance,this.object,c.I18n.getLanguage())];return a[0].xticks=this.loadChartParam("xticks",""),a[0].yticks=this.loadChartParam("yticks",""),{marks:[],lines:a,zoom:!0,hoverDetail:!0,aggregate:this.loadChartParam("aggregate","minmax"),chartType:this.loadChartParam("chartType","auto"),live:this.loadChartParam("live","30"),timeType:this.loadChartParam("timeType","relative"),aggregateType:this.loadChartParam("aggregateType","step"),aggregateSpan:this.loadChartParam("aggregateSpan","300"),ticks:this.loadChartParam("ticks",""),range:this.loadChartParam("range","1440"),relativeEnd:this.loadChartParam("relativeEnd","now"),start:this.loadChartParam("start",""),end:this.loadChartParam("end",""),start_time:this.loadChartParam("start_time",""),end_time:this.loadChartParam("end_time",""),noBorder:"noborder",noedit:!1,animation:0,legend:""}}onReceiveMessage=a=>{var s,e;(a==null?void 0:a.data)==="chartReady"&&(this.ready=!0,this.state.presetData&&(this.lastPresetData=JSON.stringify(this.state.presetData),(e=(s=this.refIframe.current)==null?void 0:s.contentWindow)==null||e.postMessage(this.lastPresetData,"*"),console.log("Received ready from iframe")))};renderWidgetBody(a){var e,r;super.renderWidgetBody(a);let s;if((!this.state.rxData.echart_oid||this.state.rxData.echart_oid==="nothing_selected")&&!this.state.presetData)s=n.jsx("div",{style:{padding:8,width:"calc(100% - 16px)",height:"calc(100% - 16px)",backgroundColor:this.state.rxData.noChartBackground?void 0:this.props.context.themeType==="dark"?"rgb(31, 31, 31)":"#f0f0f0"},children:c.I18n.t("echarts_chart_not_selected")});else{const i=JSON.stringify(this.state.presetData);this.ready&&this.lastPresetData!==i&&(this.lastPresetData=i,(r=(e=this.refIframe.current)==null?void 0:e.contentWindow)==null||r.postMessage(this.lastPresetData,"*")),s=n.jsx("iframe",{ref:this.refIframe,title:this.state.rxData.echart_oid||this.state.rxData.history_oid,style:{width:"100%",height:"100%",border:0},src:this.state.rxData.echart_oid?`../echarts/index.html?preset=${this.state.rxData.echart_oid}&noBG=${this.state.rxData.noChartBackground||!this.state.rxData.noCard}`:`../echarts/index.html?noBG=${this.state.rxData.noChartBackground||!this.state.rxData.noCard}&edit=true`})}return this.state.rxData.noCard?s:this.wrapContent(s)}}export{_ as default};
